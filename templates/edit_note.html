{% extends "base.html" %}
{% block title %}Editar {{ note.title }} - CAIOBOOK{% endblock %}

{% block content %}
<section class="max-w-4xl mx-auto px-4 py-8">
  <!-- Cabeçalho -->
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">
      Editando: {{ note.title }}
    </h1>
    <p class="mt-2">
      <a href="{{ url_for('view_note', note_id=note.id) }}" class="text-blue-500 hover:underline">
        <i class="fa fa-eye mr-1"></i> Visualizar Nota
      </a>
    </p>
  </header>

  <!-- Formulário de Edição -->
  <form id="note-form" method="POST" action="{{ url_for('edit_note', note_id=note.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Campo Título -->
    <div class="mb-4">
      <label for="title" class="block text-lg font-semibold text-gray-700">Título</label>
      <input type="text" name="title" id="title" value="{{ note.title }}" required
             class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <!-- Editor Vditor -->
    <div class="mb-4">
      <!-- Div onde o Vditor será renderizado -->
      <div id="vditor" style="height: 500px;"></div>
      <!-- Campo oculto que receberá o conteúdo do editor para envio -->
      <textarea name="content" id="content" style="display: none;"></textarea>
    </div>

    <!-- Botões de Ação -->
    <div class="flex flex-wrap justify-end space-x-4 border-t pt-4">
      <a href="{{ url_for('view_note', note_id=note.id) }}"
         class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
         Cancelar
      </a>

      <!-- Botão para alternar entre pública e privada -->
      <button id="toggle-public-btn" type="button"
              class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">
        {% if note.is_public %}
          Tornar Privada
        {% else %}
          Tornar Pública
        {% endif %}
      </button>

      <!-- Botão de Compartilhar, exibido somente se a nota for pública -->
      {% if note.is_public %}
      <button id="share-button" type="button"
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
        <i class="fa fa-share-alt mr-2"></i> Compartilhar
      </button>
      {% endif %}

      <!-- Botão de Salvar -->
      <button type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
         <i class="fa fa-save mr-2"></i> Salvar
      </button>
    </div>
  </form>
</section>

<!-- INCLUDES -->
<!-- Font Awesome para ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Vditor CSS e JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor/dist/index.min.css">
<script src="https://cdn.jsdelivr.net/npm/vditor/dist/index.min.js"></script>

<!-- Estilos customizados para aumentar os botões da toolbar -->
<style>
  /* Aumenta o tamanho dos ícones e o padding dos botões da toolbar do Vditor */
  .vditor-toolbar .vditor-toolbar__item {
    font-size: 2rem; /* Aumenta o tamanho do ícone */
    padding: 0.75rem; /* Aumenta o espaçamento interno */
  }
</style>

<!-- Script de Inicialização do Vditor e funcionalidades dos botões -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Inicializa o Vditor no elemento "vditor"
    const vditor = new Vditor('vditor', {
        height: 500,
        mode: 'ir', // Modo Instant Rendering (visualização em tempo real)
        lang: "pt_BR",
        toolbar: [
            "bold", "italic", "strike",
            "list", "ordered-list",
            "quote", "code",
            "link", "image", "table",
            "undo", "redo",
            "preview", "fullscreen"
        ],
        value: {{ note.content|tojson|safe }}
    });

    // Ao enviar o formulário, atualiza o campo oculto com o conteúdo atual do editor
    document.getElementById('note-form').addEventListener('submit', function() {
      document.getElementById('content').value = vditor.getValue();
    });

    // Mapeamento dos tooltips do inglês para o português
    const tooltipMapping = {
      "Bold": "Negrito",
      "Italic": "Itálico",
      "Strike": "Tachado",
      "List": "Lista",
      "Ordered List": "Lista Ordenada",
      "Quote": "Citação",
      "Code": "Código",
      "Link": "Link",
      "Image": "Imagem",
      "Table": "Tabela",
      "Undo": "Desfazer",
      "Redo": "Refazer",
      "Preview": "Visualizar",
      "Fullscreen": "Tela Cheia"
    };

    // Aguarda um curto delay para garantir que a toolbar foi renderizada e atualiza os tooltips
    setTimeout(function() {
      document.querySelectorAll('.vditor-toolbar__item').forEach(function(btn) {
        let currentTitle = btn.getAttribute('title');
        if (currentTitle && tooltipMapping[currentTitle]) {
          btn.setAttribute('title', tooltipMapping[currentTitle]);
        }
      });
    }, 500);

    // Função para copiar o link para a área de transferência e notificar o usuário
    function copyLink(link) {
      navigator.clipboard.writeText(link)
        .then(() => alert("Link copiado para a área de transferência!"))
        .catch(() => alert("Falha ao copiar o link."));
    }

    // Função para alternar a visibilidade da nota
    function togglePublic() {
      fetch("{{ url_for('toggle_public', note_id=note.id) }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token() }}"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === "success") {
          // Se a resposta contiver share_link, a nota ficou pública
          if (data.share_link) {
            document.getElementById("toggle-public-btn").innerText = "Tornar Privada";
            // Cria ou atualiza o botão de compartilhar
            let shareBtn = document.getElementById("share-button");
            if (!shareBtn) {
              shareBtn = document.createElement("button");
              shareBtn.id = "share-button";
              shareBtn.type = "button";
              shareBtn.className = "px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition";
              shareBtn.innerHTML = '<i class="fa fa-share-alt mr-2"></i> Compartilhar';
              // Insere o botão após o botão de toggle
              const toggleBtn = document.getElementById("toggle-public-btn");
              toggleBtn.parentNode.insertBefore(shareBtn, toggleBtn.nextSibling);
            }
            // Atualiza o evento de clique para copiar o link
            document.getElementById("share-button").onclick = function() {
              copyLink(data.share_link);
            };
          } else {
            // Se não houver share_link, a nota ficou privada
            document.getElementById("toggle-public-btn").innerText = "Tornar Pública";
            const shareBtn = document.getElementById("share-button");
            if (shareBtn) {
              shareBtn.remove();
            }
          }
        } else {
          alert(data.message || "Ocorreu um erro ao alternar a visibilidade da nota.");
        }
      })
      .catch(error => {
        console.error("Erro:", error);
        alert("Erro na comunicação com o servidor.");
      });
    }

    // Associa o evento de clique do botão de alternar visibilidade
    document.getElementById("toggle-public-btn").addEventListener("click", togglePublic);

    // Se o botão de compartilhar já existir, associa seu evento de clique para copiar o link
    const shareButton = document.getElementById("share-button");
    if (shareButton) {
      shareButton.addEventListener("click", function() {
        // Faz uma nova requisição para garantir que o link esteja atualizado
        fetch("{{ url_for('toggle_public', note_id=note.id) }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}"
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === "success" && data.share_link) {
            copyLink(data.share_link);
          }
        });
      });
    }
  });
</script>
{% endblock %}
